<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Baqarah Counter</title>

  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { background:#f0f4f0; font-family: ui-sans-serif, system-ui, -apple-system, "Inter", Segoe UI, Roboto, Arial; }
    .gold { color:#D4AF37; }
    .bg-islamic-green { background:#006400; }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

    /* Print/PDF mode: show only PDF page */
    @media print {
      nav, #menu, #lockdownBanner, #countdownCard, #homeGrid, #countingPage, #adminPage, #authModal, #toast {
        display:none !important;
      }
      #pdfPage { display:block !important; }
      body { background:white !important; }
      .print-card { border: 1px solid #e5e7eb !important; box-shadow:none !important; }
    }
  </style>
</head>

<body class="pb-10">

  <!-- NAV -->
  <nav class="bg-islamic-green text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-40">
    <div class="flex items-center gap-2">
      <i class="fa-solid fa-book-quran text-white/90"></i>
      <h1 id="navTitle" class="text-xl font-bold italic">Baqarah Counter</h1>
    </div>

    <div class="flex items-center gap-3">
      <div id="authSection">
        <button id="authBtnTop" onclick="openAuthModal()"
          class="bg-white text-green-900 px-4 py-1 rounded-full text-sm font-semibold hover:bg-gray-100">
          Login / Sign Up
        </button>
      </div>

      <!-- 3-line menu -->
      <button id="menuBtn"
        class="w-10 h-10 rounded-xl bg-white/10 hover:bg-white/15 flex items-center justify-center"
        aria-label="Menu" title="Menu">
        <i class="fa-solid fa-bars"></i>
      </button>
    </div>
  </nav>

  <!-- MENU DROPDOWN -->
  <div id="menu" class="hidden fixed top-[72px] right-4 w-[260px] bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden z-50">
    <div class="p-3 border-b border-gray-100">
      <p class="text-xs text-gray-500">Navigation</p>
      <p id="menuHint" class="text-sm font-semibold text-gray-800">Login to start</p>
    </div>

    <button class="w-full text-left px-4 py-3 hover:bg-gray-50 flex justify-between items-center" onclick="showSection('home')">
      <span class="font-semibold text-gray-700">Home</span>
      <i class="fa-solid fa-house text-gray-400"></i>
    </button>

    <button class="w-full text-left px-4 py-3 hover:bg-gray-50 flex justify-between items-center" onclick="showSection('leaderboard')">
      <span class="font-semibold text-gray-700">Leaderboard</span>
      <i class="fa-solid fa-trophy text-gray-400"></i>
    </button>

    <button class="w-full text-left px-4 py-3 hover:bg-gray-50 flex justify-between items-center" onclick="showSection('counting')">
      <span class="font-semibold text-gray-700">Counting</span>
      <i class="fa-solid fa-check text-gray-400"></i>
    </button>

    <button id="adminNavBtn" class="hidden w-full text-left px-4 py-3 hover:bg-gray-50 flex justify-between items-center" onclick="showSection('admin')">
      <span class="font-semibold text-gray-700">Admin</span>
      <i class="fa-solid fa-lock text-gray-400"></i>
    </button>

    <div class="border-t border-gray-100"></div>

    <button id="authBtnMenu" class="w-full text-left px-4 py-3 hover:bg-gray-50 flex justify-between items-center" onclick="openAuthModal()">
      <span class="font-semibold text-green-800">Login / Sign Up</span>
      <i class="fa-solid fa-right-to-bracket text-green-700"></i>
    </button>

    <button id="logoutBtn" class="hidden w-full text-left px-4 py-3 hover:bg-gray-50 flex justify-between items-center" onclick="logout()">
      <span class="font-semibold text-red-600">Logout</span>
      <i class="fa-solid fa-arrow-right-from-bracket text-red-500"></i>
    </button>
  </div>

  <!-- LOCKDOWN BANNER -->
  <div id="lockdownBanner" class="hidden max-w-4xl mx-auto mt-6 px-4">
    <div class="bg-white border border-gray-100 rounded-3xl shadow-sm p-5 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div>
        <p class="text-sm font-extrabold text-red-700">Event has started ‚Äî Read-only mode (Members)</p>
        <p class="text-gray-600 text-sm">
          Members can‚Äôt login, sign up, count, or edit. Admin can still manage everything.
        </p>
      </div>
      <button onclick="openPdfViewAndPrint()" class="bg-green-700 hover:bg-green-800 text-white px-5 py-3 rounded-2xl font-bold">
        Save as PDF
      </button>
    </div>
  </div>

  <!-- COUNTDOWN CARD -->
  <div id="countdownCard" class="max-w-4xl mx-auto mt-10 text-center p-6 bg-white rounded-3xl shadow-sm border border-gray-100">
    <h2 id="countdownTitle" class="text-3xl font-bold text-gray-800 mb-4">Days till: Ramadan 2026</h2>

    <div id="countdown" class="grid grid-cols-4 gap-4 text-center">
      <div class="bg-green-50 p-4 rounded-xl">
        <span id="days" class="text-3xl md:text-4xl font-bold text-green-800">00</span>
        <p class="text-xs uppercase text-green-600">Days</p>
      </div>
      <div class="bg-green-50 p-4 rounded-xl">
        <span id="hours" class="text-3xl md:text-4xl font-bold text-green-800">00</span>
        <p class="text-xs uppercase text-green-600">Hours</p>
      </div>
      <div class="bg-green-50 p-4 rounded-xl">
        <span id="minutes" class="text-3xl md:text-4xl font-bold text-green-800">00</span>
        <p class="text-xs uppercase text-green-600">Mins</p>
      </div>
      <div class="bg-green-50 p-4 rounded-xl">
        <span id="seconds" class="text-3xl md:text-4xl font-bold text-green-800">00</span>
        <p class="text-xs uppercase text-green-600">Secs</p>
      </div>
    </div>

    <p id="targetLabel" class="mt-4 text-sm text-gray-500"></p>
  </div>

  <!-- HOME GRID -->
  <div id="homeGrid" class="max-w-4xl mx-auto mt-8 grid grid-cols-1 md:grid-cols-2 gap-8 px-4">

    <!-- Today's Progress -->
    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
      <h3 class="text-xl font-bold mb-4 text-gray-700">
        <i class="fa-solid fa-book-quran gold"></i>
        Today's Progress
      </h3>

      <div id="userStats" class="hidden">
        <p class="mb-4 text-gray-600">
          As-salaamu alaikum, <span id="displayName" class="font-bold text-green-700">User</span>!
        </p>

        <div class="bg-green-100 p-4 rounded-2xl mb-4 text-center">
          <p class="text-sm text-green-800">Current Streak</p>
          <p class="text-5xl font-black text-green-900" id="streakCount">0</p>
        </div>

        <button id="markDoneBtn" onclick="markAsDone()"
          class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold hover:bg-green-700 transition">
          I Completed Today
        </button>

        <p id="ordinalLine" class="mt-4 text-center text-sm font-bold text-green-800"></p>
      </div>

      <div id="guestPrompt" class="text-center py-10">
        <p class="text-gray-500 mb-4">Please login to track your streak!</p>
        <button onclick="openAuthModal()" class="text-green-600 font-bold underline">Login Now</button>
      </div>

      <div id="lockedPromptHome" class="hidden text-center py-10">
        <p class="text-gray-500 mb-4">Read-only mode is active for members.</p>
        <button onclick="openPdfViewAndPrint()" class="text-green-700 font-bold underline">Save as PDF</button>
      </div>
    </div>

    <!-- Leaderboard -->
    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
      <h3 id="leaderboardTitle" class="text-xl font-bold mb-4 text-gray-700">
        <i class="fa-solid fa-trophy gold"></i>
        Global Leaderboard
      </h3>

      <input id="searchBox" class="w-full border p-3 rounded-xl mb-4 focus:outline-green-600"
             placeholder="Search people..." />

      <div id="leaderboardHiddenMsg" class="hidden text-gray-500 text-center py-8">
        Leaderboard is hidden by admin.
      </div>

      <div class="space-y-3" id="leaderboardList">
        <p class="text-gray-400 text-center py-4 italic">Loading rankings...</p>
      </div>

      <div id="yourRankBox" class="hidden mt-4 bg-green-50 border border-green-100 rounded-2xl p-4 text-center">
        <p id="yourRankText" class="text-lg font-extrabold text-green-900">‚Äî</p>
      </div>
    </div>
  </div>

  <!-- COUNTING PAGE -->
  <div id="countingPage" class="hidden max-w-4xl mx-auto mt-8 px-4">
    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
      <h3 class="text-xl font-bold mb-4 text-gray-700">
        <i class="fa-solid fa-check gold"></i> Counting
      </h3>

      <div id="countingGuest" class="text-center py-10">
        <p class="text-gray-500 mb-4">Please login to use counting.</p>
        <button onclick="openAuthModal()" class="text-green-600 font-bold underline">Login Now</button>
      </div>

      <div id="countingLocked" class="hidden text-center py-10">
        <p class="text-gray-500 mb-4">Read-only mode is active for members.</p>
        <button onclick="openPdfViewAndPrint()" class="text-green-700 font-bold underline">Save as PDF</button>
      </div>

      <div id="countingUser" class="hidden">
        <button id="countBtn" onclick="markAsDone()"
          class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold hover:bg-green-700 transition">
          I Completed Today
        </button>

        <div class="bg-green-50 border border-green-100 p-4 rounded-2xl mt-4 text-center">
          <p id="countStatus" class="text-sm text-green-700 font-semibold">‚Äî</p>
          <p id="countOrdinal" class="text-lg font-extrabold text-green-900">‚Äî</p>
        </div>

        <!-- Qur‚Äôan preview -->
        <div class="mt-6 border border-gray-100 rounded-3xl overflow-hidden">
          <div class="p-4 bg-gray-50 flex items-center justify-between">
            <div class="font-bold text-gray-700">
              <i class="fa-solid fa-book-quran gold"></i>
              <span id="quranTitle">Quran Pages</span>
            </div>
            <div id="pageIndicator" class="text-sm text-gray-500 font-semibold">‚Äî</div>
          </div>

          <div id="swipeArea" class="p-4 bg-white">
            <div id="pagesGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

            <div class="mt-4 flex gap-3">
              <button id="prevBtn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-2xl font-bold transition">‚Üê</button>
              <button id="nextBtn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-2xl font-bold transition">‚Üí</button>
            </div>

            <p class="mt-4 text-xs text-gray-400">
              Put images named 001.jpg ‚Ä¶ 450.jpg in a folder (example: quran-pages). Admin controls the template + range.
            </p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ADMIN PAGE -->
  <div id="adminPage" class="hidden max-w-4xl mx-auto mt-8 px-4">
    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
      <h3 class="text-xl font-bold mb-2 text-gray-700">
        <i class="fa-solid fa-lock gold"></i> Admin Panel
      </h3>
      <p class="text-gray-500 mb-6">
        Admin can manage everything (even after event start). Members become read-only after the target date.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- App / Event / Leaderboard settings -->
        <div class="border border-gray-100 rounded-3xl p-5">
          <h4 class="font-extrabold text-gray-800 mb-2">Top Bar + Countdown</h4>

          <label class="block text-xs font-bold text-gray-500 mt-3">App name</label>
          <input id="appNameInput" class="w-full border p-3 rounded-xl focus:outline-green-600" placeholder="Baqarah Counter">

          <label class="block text-xs font-bold text-gray-500 mt-3">Days till: (freeform)</label>
          <input id="eventNameInput" class="w-full border p-3 rounded-xl focus:outline-green-600" placeholder="Ramadan / Eid / Anything">

          <label class="block text-xs font-bold text-gray-500 mt-3">Target date/time</label>
          <input id="targetInput" class="w-full border p-3 rounded-xl focus:outline-green-600" placeholder="YYYY-MM-DD HH:MM:SS">

          <label class="block text-xs font-bold text-gray-500 mt-3">Show leaderboard to members</label>
          <div class="mt-2 flex items-center justify-between bg-gray-50 border border-gray-100 rounded-2xl p-4">
            <p class="text-sm text-gray-700 font-semibold">Leaderboard Visible</p>
            <label class="inline-flex items-center cursor-pointer">
              <input id="showLeaderboardToggle" type="checkbox" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-300 rounded-full peer peer-checked:bg-green-700 relative">
                <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-all peer-checked:translate-x-5"></div>
              </div>
            </label>
          </div>

          <label class="block text-xs font-bold text-gray-500 mt-3">Top N (how many people)</label>
          <input id="topNInput" class="w-full border p-3 rounded-xl focus:outline-green-600" inputmode="numeric" placeholder="10">

          <button id="saveTopBtn" onclick="saveTopSettings()" class="mt-4 w-full bg-islamic-green text-white py-3 rounded-2xl font-bold hover:opacity-95">
            Save
          </button>
        </div>

        <!-- Qur‚Äôan pages settings -->
        <div class="border border-gray-100 rounded-3xl p-5">
          <h4 class="font-extrabold text-gray-800 mb-2">Qur‚Äôan Pages</h4>

          <label class="block text-xs font-bold text-gray-500 mt-3">Preview title (freeform)</label>
          <input id="qTitleInput" class="w-full border p-3 rounded-xl focus:outline-green-600" placeholder="Quran Pages">

          <div class="grid grid-cols-2 gap-3 mt-3">
            <div>
              <label class="block text-xs font-bold text-gray-500">Start page</label>
              <input id="startPageInput" class="w-full border p-3 rounded-xl focus:outline-green-600" inputmode="numeric" placeholder="1">
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500">End page</label>
              <input id="endPageInput" class="w-full border p-3 rounded-xl focus:outline-green-600" inputmode="numeric" placeholder="450">
            </div>
          </div>

          <label class="block text-xs font-bold text-gray-500 mt-3">Image template</label>
          <input id="templateInput" class="w-full border p-3 rounded-xl focus:outline-green-600"
                 placeholder="quran-pages/{page3}.jpg">
          <p class="text-xs text-gray-400 mt-2">
            Use <code>{page3}</code> for 3-digit filenames like 001.jpg, 080.jpg, 450.jpg.
          </p>

          <button id="saveQBtn" onclick="saveQuranSettings()" class="mt-4 w-full bg-islamic-green text-white py-3 rounded-2xl font-bold hover:opacity-95">
            Save
          </button>
        </div>
      </div>

      <!-- Admin create new user -->
      <div class="mt-8 border border-gray-100 rounded-3xl p-5">
        <h4 class="font-extrabold text-gray-800 mb-3">Create New Account (Admin)</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="newUserU" class="w-full border p-3 rounded-xl focus:outline-green-600" placeholder="Username">
          <input id="newUserN" class="w-full border p-3 rounded-xl focus:outline-green-600" placeholder="Display Name">
          <input id="newUserP" class="w-full border p-3 rounded-xl focus:outline-green-600" placeholder="Password" type="password">
        </div>
        <div class="mt-3 flex flex-col md:flex-row gap-3">
          <select id="newUserRole" class="w-full border p-3 rounded-xl focus:outline-green-600">
            <option value="Member">Member</option>
            <option value="Admin">Admin</option>
          </select>
          <button onclick="adminCreateUser()" class="w-full bg-green-700 hover:bg-green-800 text-white py-3 rounded-2xl font-bold">
            Create User
          </button>
        </div>
        <p class="text-xs text-gray-400 mt-2">Admin can create users anytime (even after event start).</p>
      </div>

      <div class="mt-8">
        <h4 class="font-extrabold text-gray-800 mb-3">Manage Users</h4>
        <div id="adminUsers" class="space-y-4"></div>

        <div class="mt-6 flex flex-col sm:flex-row gap-3">
          <button onclick="exportData()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-2xl font-bold transition">
            Export Data (Copy JSON)
          </button>
          <button onclick="wipeAll()" class="w-full bg-red-50 hover:bg-red-100 text-red-700 py-3 rounded-2xl font-bold transition border border-red-200">
            Wipe ALL Data
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div id="authModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white p-8 rounded-3xl max-w-lg w-full shadow-2xl">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-2xl font-bold">Login / Sign Up</h2>
        <button onclick="closeAuthModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>

      <!-- Mobile: Login then Sign Up under -->
      <div class="block md:hidden">
        <div class="border border-gray-100 rounded-2xl p-4">
          <h3 class="font-extrabold text-gray-800 mb-2">Login</h3>
          <input id="loginUser_m" placeholder="Username" class="w-full border p-3 rounded-xl mb-3 focus:outline-green-600">
          <input id="loginPass_m" type="password" placeholder="Password" class="w-full border p-3 rounded-xl mb-3 focus:outline-green-600">
          <button onclick="loginMobile()" class="w-full bg-islamic-green text-white py-3 rounded-xl font-bold">Login</button>
        </div>

        <div class="mt-4 border border-gray-100 rounded-2xl p-4">
          <h3 class="font-extrabold text-gray-800 mb-2">Sign Up</h3>
          <input id="suUser_m" placeholder="Username" class="w-full border p-3 rounded-xl mb-3 focus:outline-green-600">
          <input id="suName_m" placeholder="Display Name" class="w-full border p-3 rounded-xl mb-3 focus:outline-green-600">
          <input id="suPass_m" type="password" placeholder="Password" class="w-full border p-3 rounded-xl mb-3 focus:outline-green-600">
          <button onclick="signupMobile()" class="w-full bg-gray-100 text-gray-800 py-3 rounded-xl font-bold">Sign Up</button>
        </div>
      </div>

      <!-- Desktop: two columns -->
      <div class="hidden md:grid grid-cols-2 gap-4 mt-2">
        <div class="border border-gray-100 rounded-2xl p-4">
          <h3 class="font-extrabold text-gray-800 mb-2">Login</h3>
          <input id="loginUser" placeholder="Username" class="w-full border p-3 rounded-xl mb-3 focus:outline-green-600">
          <input id="loginPass" type="password" placeholder="Password" class="w-full border p-3 rounded-xl mb-3 focus:outline-green-600">
          <button onclick="loginDesktop()" class="w-full bg-islamic-green text-white py-3 rounded-xl font-bold">Login</button>
        </div>

        <div class="border border-gray-100 rounded-2xl p-4">
          <h3 class="font-extrabold text-gray-800 mb-2">Sign Up</h3>
          <input id="suUser" placeholder="Username" class="w-full border p-3 rounded-xl mb-3 focus:outline-green-600">
          <input id="suName" placeholder="Display Name" class="w-full border p-3 rounded-xl mb-3 focus:outline-green-600">
          <input id="suPass" type="password" placeholder="Password" class="w-full border p-3 rounded-xl mb-3 focus:outline-green-600">
          <button onclick="signupDesktop()" class="w-full bg-gray-100 text-gray-800 py-3 rounded-xl font-bold">Sign Up</button>
        </div>
      </div>

      <p id="authLockMsg" class="hidden mt-4 text-sm text-red-700 font-bold">
        Event has started ‚Äî members can‚Äôt login/sign up. Admin can still login.
      </p>

      <button onclick="closeAuthModal()" class="w-full mt-4 text-gray-400 text-sm">Cancel</button>
    </div>
  </div>

  <!-- PDF PAGE (hidden normally; visible on print) -->
  <div id="pdfPage" class="hidden max-w-3xl mx-auto mt-10 px-6">
    <div class="print-card bg-white rounded-3xl shadow-sm p-8">
      <h1 class="text-2xl font-extrabold text-gray-900 mb-2" id="pdfGreeting">As-salaamu alaikum, Guest</h1>
      <p class="text-gray-600 mb-6" id="pdfEventLine">‚Äî</p>

      <div id="pdfLeaderboardBlock" class="mt-6">
        <h2 class="text-lg font-extrabold text-gray-900 mb-3">Leaderboard</h2>
        <div id="pdfLeaderboard" class="space-y-2"></div>
      </div>

      <div id="pdfYourRankBlock" class="mt-6 bg-green-50 border border-green-100 rounded-2xl p-4">
        <p class="text-sm text-green-700 font-semibold">Your place</p>
        <p id="pdfYourRank" class="text-lg font-extrabold text-green-900">‚Äî</p>
      </div>

      <p class="mt-8 text-xs text-gray-400">Generated by Baqarah Counter (Print / Save as PDF)</p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-white text-gray-800 px-4 py-3 rounded-2xl shadow-xl border border-gray-100 z-[60]">
    <span id="toastMsg" class="font-semibold"></span>
  </div>

<script>
/* ======================
   Admin Credentials
====================== */
const ADMIN_USERNAME = "Admin00";
const ADMIN_PASSWORD = "Admin0000";

/* ======================
   Storage Keys
====================== */
const KEY_USERS = "baqarah_users_v1";
const KEY_SESSION = "baqarah_session_v1";
const KEY_SETTINGS = "baqarah_settings_v1";

/* ======================
   Default Settings
====================== */
const defaultSettings = {
  appName: "Baqarah Counter",
  eventName: "Ramadan 2026",
  targetDateTime: "2026-02-18 00:00:00",
  showLeaderboard: true,
  topN: 10,

  // Qur‚Äôan preview (your images are 001.jpg...450.jpg)
  quranPreviewTitle: "Quran Pages",
  startPage: 2,
  endPage: 49,
  pageTemplate: "quran-pages/{page3}.jpg"
};

/* ======================
   Helpers
====================== */
function loadJSON(key, fallback){
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
  catch { return fallback; }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function loadUsers(){ return loadJSON(KEY_USERS, {}); }
function saveUsers(u){ saveJSON(KEY_USERS, u); }

function loadSession(){ return loadJSON(KEY_SESSION, { username:null }); }
function saveSession(s){ saveJSON(KEY_SESSION, s); }

function loadSettings(){
  const s = loadJSON(KEY_SETTINGS, null);
  return s ? ({...defaultSettings, ...s}) : ({...defaultSettings});
}
function saveSettings(s){ saveJSON(KEY_SETTINGS, s); }

function toast(msg){
  document.getElementById("toastMsg").textContent = msg;
  const t = document.getElementById("toast");
  t.classList.remove("hidden");
  setTimeout(()=>t.classList.add("hidden"), 2200);
}

function escapeHTML(str){
  return String(str)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

function todayISO(){ return new Date().toISOString().split("T")[0]; }
function yesterdayISO(){
  const d = new Date(); d.setDate(d.getDate()-1);
  return d.toISOString().split("T")[0];
}

function ordinal(n){
  const s=["th","st","nd","rd"], v=n%100;
  return n + (s[(v-20)%10] || s[v] || s[0]);
}

function parseTargetDateTime(str){
  const s = (str||"").trim();
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})(?::(\d{2}))?$/);
  if(m){
    const [_,Y,Mo,D,H,Mi,S] = m;
    return new Date(Number(Y), Number(Mo)-1, Number(D), Number(H), Number(Mi), Number(S||"0")).getTime();
  }
  const d = new Date(s);
  if(!isNaN(d.getTime())) return d.getTime();
  return new Date(2026,1,18,0,0,0).getTime();
}

function getCurrentUser(){
  const sess = loadSession();
  if(!sess.username) return null;
  const u = loadUsers()[sess.username];
  return u || null;
}

function isAdmin(){
  const u = getCurrentUser();
  return !!(u && u.role === "Admin");
}

/* Members locked after event start, Admin NOT locked */
function isMemberLocked(){
  const s = loadSettings();
  const target = parseTargetDateTime(s.targetDateTime);
  return Date.now() >= target && !isAdmin();
}

/* ======================
   Ensure Admin User Exists
====================== */
async function ensureAdmin(){
  const users = loadUsers();
  const adminHash = await sha256(ADMIN_PASSWORD);

  if(!users[ADMIN_USERNAME]){
    users[ADMIN_USERNAME] = {
      username: ADMIN_USERNAME,
      displayName: "Admin",
      passHash: adminHash,
      totalDays: 0,
      streak: 0,
      lastDone: null,
      role: "Admin",
      hideFromLeaderboard: false,
      createdAt: Date.now()
    };
    saveUsers(users);
  } else {
    // Force role + keep existing password unless empty
    users[ADMIN_USERNAME].role = "Admin";
    if(!users[ADMIN_USERNAME].passHash) users[ADMIN_USERNAME].passHash = adminHash;
    if(users[ADMIN_USERNAME].hideFromLeaderboard === undefined) users[ADMIN_USERNAME].hideFromLeaderboard = false;
    saveUsers(users);
  }
}

/* ======================
   Menu open/close
====================== */
const menu = document.getElementById("menu");
document.getElementById("menuBtn").addEventListener("click", ()=> menu.classList.toggle("hidden"));
document.addEventListener("click", (e)=>{
  const btn = document.getElementById("menuBtn");
  if(!menu.classList.contains("hidden")){
    if(!menu.contains(e.target) && !btn.contains(e.target)) menu.classList.add("hidden");
  }
});

/* ======================
   Sections
====================== */
function showSection(which){
  menu.classList.add("hidden");

  const homeGrid = document.getElementById("homeGrid");
  const countingPage = document.getElementById("countingPage");
  const adminPage = document.getElementById("adminPage");

  homeGrid.classList.remove("hidden");
  countingPage.classList.add("hidden");
  adminPage.classList.add("hidden");

  if(which === "counting"){
    homeGrid.classList.add("hidden");
    countingPage.classList.remove("hidden");
    renderQuran(false);
    window.scrollTo({top: countingPage.offsetTop - 80, behavior:"smooth"});
  } else if(which === "admin"){
    if(!isAdmin()){ toast("Admins only."); return; }
    homeGrid.classList.add("hidden");
    adminPage.classList.remove("hidden");
    fillAdminInputs();
    renderAdminUsers();
    window.scrollTo({top: adminPage.offsetTop - 80, behavior:"smooth"});
  } else if(which === "leaderboard"){
    const el = document.getElementById("leaderboardTitle");
    window.scrollTo({top: el.offsetTop - 120, behavior:"smooth"});
  } else {
    window.scrollTo({top: 0, behavior:"smooth"});
  }
}

/* ======================
   Auth Modal
====================== */
function openAuthModal(){
  const locked = isMemberLocked();
  const msg = document.getElementById("authLockMsg");
  msg.classList.toggle("hidden", !locked);
  document.getElementById("authModal").classList.remove("hidden");
}
function closeAuthModal(){ document.getElementById("authModal").classList.add("hidden"); }
window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeAuthModal(); });

/* ======================
   Signup / Login / Logout
====================== */
async function signup(username, displayName, password){
  // Members blocked after event start; admin can still create from Admin panel anyway
  if(isMemberLocked()) return toast("Event started. Members can't sign up.");

  username = (username||"").trim();
  displayName = (displayName||"").trim();
  password = (password||"").trim();
  if(!username || !displayName || !password) return toast("Fill all fields.");
  if(username.length < 3) return toast("Username too short.");

  const users = loadUsers();
  if(users[username]) return toast("Username already exists.");

  users[username] = {
    username,
    displayName,
    passHash: await sha256(password),
    totalDays: 0,
    streak: 0,
    lastDone: null,
    role: "Member",
    hideFromLeaderboard: false,
    createdAt: Date.now()
  };
  saveUsers(users);
  toast("Account created!");
  renderAll();
}

async function login(username, password){
  // Members blocked after event start, Admin still allowed
  const locked = isMemberLocked();
  username = (username||"").trim();
  password = (password||"").trim();
  if(!username || !password) return toast("Enter username & password.");

  const users = loadUsers();
  const u = users[username];
  if(!u) return toast("User not found.");

  // If locked and NOT admin username ‚Üí block
  if(locked && username !== ADMIN_USERNAME) return toast("Event started. Members can't login.");

  const h = await sha256(password);
  if(h !== u.passHash) return toast("Wrong password.");

  saveSession({username});
  closeAuthModal();
  toast("Logged in!");
  renderAll();
}

function logout(){
  saveSession({username:null});
  toast("Logged out.");
  renderAll();
}

/* Modal wiring */
function signupDesktop(){ signup(suUser.value, suName.value, suPass.value); }
function loginDesktop(){ login(loginUser.value, loginPass.value); }
function signupMobile(){ signup(suUser_m.value, suName_m.value, suPass_m.value); }
function loginMobile(){ login(loginUser_m.value, loginPass_m.value); }

/* ======================
   Countdown
====================== */
function updateCountdown(){
  const settings = loadSettings();
  const target = parseTargetDateTime(settings.targetDateTime);
  const now = Date.now();
  const distance = target - now;

  document.getElementById("countdownTitle").textContent = `Days till: ${settings.eventName}`;
  document.getElementById("targetLabel").textContent = `Target: ${settings.targetDateTime}`;

  if(distance <= 0){
    ["days","hours","minutes","seconds"].forEach(id => document.getElementById(id).innerText="00");
    return;
  }

  const dd = Math.floor(distance / (1000*60*60*24));
  const hh = Math.floor((distance % (1000*60*60*24)) / (1000*60*60));
  const mm = Math.floor((distance % (1000*60*60)) / (1000*60));
  const ss = Math.floor((distance % (1000*60)) / 1000);

  document.getElementById("days").innerText = String(dd).padStart(2,"0");
  document.getElementById("hours").innerText = String(hh).padStart(2,"0");
  document.getElementById("minutes").innerText = String(mm).padStart(2,"0");
  document.getElementById("seconds").innerText = String(ss).padStart(2,"0");
}

/* ======================
   Counting logic
====================== */
function alreadyDoneToday(u){ return u.lastDone === todayISO(); }

function markAsDone(){
  if(isMemberLocked()) return toast("Read-only mode (members).");
  const sess = loadSession();
  if(!sess.username) return toast("Login first.");

  const users = loadUsers();
  const u = users[sess.username];
  if(!u) return toast("User missing.");

  if(alreadyDoneToday(u)) return toast("Already completed today.");

  if(u.lastDone === yesterdayISO()) u.streak = (u.streak||0) + 1;
  else u.streak = 1;

  u.totalDays = (u.totalDays||0) + 1;
  u.lastDone = todayISO();

  users[sess.username] = u;
  saveUsers(users);

  toast("Saved ‚úÖ");
  renderAll();
}

/* ======================
   Leaderboard + rank
====================== */
function getSortedUsers(){
  const users = Object.values(loadUsers()).filter(u=>u && u.username && !u.hideFromLeaderboard);
  users.sort((a,b)=>
    (b.totalDays||0) - (a.totalDays||0) ||
    (b.streak||0) - (a.streak||0) ||
    (a.username||"").localeCompare(b.username||"")
  );
  return users;
}

function computeRank(username){
  const users = getSortedUsers();
  const idx = users.findIndex(u => u.username === username);
  return idx === -1 ? null : (idx + 1);
}

function renderLeaderboard(){
  const settings = loadSettings();
  const show = !!settings.showLeaderboard;

  const q = (document.getElementById("searchBox").value || "").trim().toLowerCase();
  const all = getSortedUsers();

  const topN = Math.max(1, Number(settings.topN) || 10);
  let top = all.slice(0, topN);

  if(q){
    top = top.filter(u =>
      (u.username||"").toLowerCase().includes(q) ||
      (u.displayName||"").toLowerCase().includes(q)
    );
  }

  // Hide list if admin disabled (members) - Admin still sees list always
  const shouldHideForThisUser = (!isAdmin() && !show);

  document.getElementById("leaderboardHiddenMsg").classList.toggle("hidden", !shouldHideForThisUser);
  document.getElementById("leaderboardList").classList.toggle("hidden", shouldHideForThisUser);
  document.getElementById("searchBox").classList.toggle("hidden", shouldHideForThisUser);

  document.getElementById("leaderboardTitle").innerHTML =
    `<i class="fa-solid fa-trophy gold"></i> Global Leaderboard (Top ${topN})`;

  if(shouldHideForThisUser){
    document.getElementById("leaderboardList").innerHTML = "";
  } else {
    const html = top.map((u,i)=>{
      const hasStreak = (u.streak||0) >= 2;
      const rankStyle = (i === 0) ? "bg-yellow-50 border border-yellow-200" : "bg-gray-50 border border-transparent";
      const nameHtml = hasStreak
        ? `<span class="font-extrabold text-red-600 flex items-center gap-2">${escapeHTML(u.displayName)} <span>üî•</span></span>`
        : `<span class="font-semibold text-gray-800">${escapeHTML(u.displayName)}</span>`;

      return `
        <div class="flex justify-between items-center p-3 ${rankStyle} rounded-xl">
          <div class="flex items-center gap-3">
            <span class="text-gray-500 font-bold w-7">${i+1}.</span>
            <div>
              ${nameHtml}
              <div class="text-xs text-gray-500">@${escapeHTML(u.username)}</div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-bold text-green-700">${u.totalDays||0} Days</div>
            <div class="text-xs text-gray-500">Streak: ${u.streak||0}</div>
          </div>
        </div>
      `;
    }).join("");

    document.getElementById("leaderboardList").innerHTML =
      html || `<p class="text-gray-400 text-center py-4 italic">No matches.</p>`;
  }

  // Your rank box (only when logged in)
  const me = getCurrentUser();
  const box = document.getElementById("yourRankBox");
  const text = document.getElementById("yourRankText");

  if(me){
    const rank = computeRank(me.username);
    if(rank !== null){
      if(rank <= topN){
        box.classList.add("hidden");
      } else {
        box.classList.remove("hidden");
        text.textContent = `As-salaamu alaikum ${me.displayName}, your place is #${rank}`;
      }
    } else {
      box.classList.add("hidden");
    }
  } else {
    box.classList.add("hidden");
  }
}

/* ======================
   Qur‚Äôan Preview (images 001.jpg etc)
====================== */
let currentPage = null;

function pad3(n){ return String(n).padStart(3,"0"); }
function pagesPerView(){ return window.matchMedia("(min-width: 768px)").matches ? 2 : 1; }

function buildPageSrc(template, pageNum){
  // Only need {page3} for your naming style
  return template.replaceAll("{page3}", pad3(pageNum));
}

function clampPage(p, s){
  const ppv = pagesPerView();
  if(ppv === 2){
    const maxStart = Math.max(s.startPage, s.endPage - 1);
    if(p < s.startPage) p = s.startPage;
    if(p > maxStart) p = maxStart;
  } else {
    if(p < s.startPage) p = s.startPage;
    if(p > s.endPage) p = s.endPage;
  }
  return p;
}

function renderQuran(reset=false){
  const s = loadSettings();
  document.getElementById("quranTitle").textContent = s.quranPreviewTitle;

  const ppv = pagesPerView();
  if(reset || currentPage === null) currentPage = s.startPage;
  currentPage = clampPage(currentPage, s);

  const wanted = (ppv === 2) ? [currentPage, currentPage+1] : [currentPage];
  const pages = wanted.filter(p => p >= s.startPage && p <= s.endPage);

  document.getElementById("pageIndicator").textContent =
    (ppv===2 && pages.length===2) ? `Pages ${pages[0]}‚Äì${pages[1]}` : `Page ${pages[0]}`;

  const grid = document.getElementById("pagesGrid");
  grid.innerHTML = pages.map(p=>{
    const src = buildPageSrc(s.pageTemplate, p);
    return `
      <div class="border border-gray-100 rounded-2xl overflow-hidden bg-gray-50">
        <div class="px-3 py-2 text-xs font-bold text-gray-600 flex justify-between items-center">
          <span>Page ${p}</span>
          <span class="text-gray-400">${escapeHTML(src)}</span>
        </div>
        <div class="bg-white">
          <img src="${src}" alt="Page ${p}"
               class="w-full h-[420px] object-contain bg-white"
               onerror="this.onerror=null; this.style.display='none'; this.parentElement.insertAdjacentHTML('beforeend','<div class=&quot;text-center text-gray-400 p-10&quot;>Missing image<br><span class=&quot;text-xs&quot;>${escapeHTML(src)}</span></div>');" />
        </div>
      </div>
    `;
  }).join("");

  const step = ppv;
  const maxStart = (ppv===2) ? Math.max(s.startPage, s.endPage - 1) : s.endPage;

  const prev = document.getElementById("prevBtn");
  const next = document.getElementById("nextBtn");

  prev.disabled = (currentPage - step) < s.startPage;
  next.disabled = (currentPage + step) > maxStart;

  prev.onclick = ()=>{ if(!prev.disabled){ currentPage = clampPage(currentPage-step, s); renderQuran(false);} };
  next.onclick = ()=>{ if(!next.disabled){ currentPage = clampPage(currentPage+step, s); renderQuran(false);} };
}

function wireSwipe(){
  const area = document.getElementById("swipeArea");
  let x0 = null;

  area.addEventListener("touchstart",(e)=>{
    if(!e.touches || e.touches.length !== 1) return;
    x0 = e.touches[0].clientX;
  }, {passive:true});

  area.addEventListener("touchend",(e)=>{
    if(x0 === null) return;
    const x1 = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientX : null;
    if(x1 === null){ x0=null; return; }
    const dx = x1 - x0;
    x0 = null;
    if(Math.abs(dx) < 40) return;
    if(dx < 0) document.getElementById("nextBtn").click();
    else document.getElementById("prevBtn").click();
  }, {passive:true});
}

/* ======================
   Admin: settings + users
====================== */
function adminGuard(){
  if(!isAdmin()) return {ok:false, msg:"Admins only."};
  return {ok:true, msg:"ok"};
}

function fillAdminInputs(){
  const s = loadSettings();
  appNameInput.value = s.appName;
  eventNameInput.value = s.eventName;
  targetInput.value = s.targetDateTime;
  showLeaderboardToggle.checked = !!s.showLeaderboard;
  topNInput.value = s.topN;

  qTitleInput.value = s.quranPreviewTitle;
  startPageInput.value = s.startPage;
  endPageInput.value = s.endPage;
  templateInput.value = s.pageTemplate;
}

function saveTopSettings(){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  const s = loadSettings();
  s.appName = (appNameInput.value || "").trim() || defaultSettings.appName;
  s.eventName = (eventNameInput.value || "").trim() || defaultSettings.eventName;
  s.targetDateTime = (targetInput.value || "").trim() || defaultSettings.targetDateTime;
  s.showLeaderboard = !!showLeaderboardToggle.checked;

  const n = Number(topNInput.value);
  s.topN = (Number.isFinite(n) && n >= 1 && n <= 200) ? Math.floor(n) : 10;

  saveSettings(s);
  toast("Saved.");
  renderAll();
}

function saveQuranSettings(){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  const s = loadSettings();
  s.quranPreviewTitle = (qTitleInput.value || "").trim() || defaultSettings.quranPreviewTitle;

  const start = Number(startPageInput.value);
  const end = Number(endPageInput.value);
  if(!Number.isFinite(start) || !Number.isFinite(end) || start < 1 || end < start){
    return toast("Fix start/end pages.");
  }
  s.startPage = Math.floor(start);
  s.endPage = Math.floor(end);

  s.pageTemplate = (templateInput.value || "").trim() || defaultSettings.pageTemplate;

  saveSettings(s);
  currentPage = s.startPage;
  toast("Saved.");
  renderAll();
}

async function adminCreateUser(){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  const username = (newUserU.value||"").trim();
  const displayName = (newUserN.value||"").trim();
  const password = (newUserP.value||"").trim();
  const role = (newUserRole.value === "Admin") ? "Admin" : "Member";

  if(!username || !displayName || !password) return toast("Fill all fields.");
  const users = loadUsers();
  if(users[username]) return toast("Username already exists.");

  users[username] = {
    username,
    displayName,
    passHash: await sha256(password),
    totalDays: 0,
    streak: 0,
    lastDone: null,
    role,
    hideFromLeaderboard: false,
    createdAt: Date.now()
  };
  saveUsers(users);

  newUserU.value = ""; newUserN.value = ""; newUserP.value = "";
  toast("User created.");
  renderAll();
}

async function adminSetPassword(username, newPass){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  newPass = (newPass||"").trim();
  if(newPass.length < 4) return toast("Password too short.");

  const users = loadUsers();
  if(!users[username]) return toast("User not found.");
  users[username].passHash = await sha256(newPass);
  saveUsers(users);
  toast("Password updated.");
}

function adminDeleteUser(username){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);
  if(username === ADMIN_USERNAME) return toast("Can't delete main admin.");

  const users = loadUsers();
  delete users[username];
  saveUsers(users);

  const sess = loadSession();
  if(sess.username === username) saveSession({username:null});

  toast("User deleted.");
  renderAll();
}

function adminAdjustDays(username, delta){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  const users = loadUsers();
  const x = users[username];
  if(!x) return toast("User not found.");
  x.totalDays = Math.max(0, (x.totalDays||0) + delta);
  users[username] = x;
  saveUsers(users);

  toast("Days updated.");
  renderAll();
}

function adminSetDays(username, days){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  const n = Number(days);
  if(Number.isNaN(n) || n < 0) return toast("Enter valid days.");

  const users = loadUsers();
  const x = users[username];
  if(!x) return toast("User not found.");
  x.totalDays = Math.floor(n);
  users[username] = x;
  saveUsers(users);

  toast("Days set.");
  renderAll();
}

function adminSetRole(username, role){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);
  if(username === ADMIN_USERNAME) return toast("Main admin role locked.");

  const users = loadUsers();
  const u = users[username];
  if(!u) return toast("User not found.");

  u.role = (role === "Admin") ? "Admin" : "Member";
  users[username] = u;
  saveUsers(users);

  toast("Role updated.");
  renderAll();
}

function adminToggleHide(username, val){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  const users = loadUsers();
  const u = users[username];
  if(!u) return toast("User not found.");
  u.hideFromLeaderboard = !!val;
  users[username] = u;
  saveUsers(users);

  toast("Updated.");
  renderAll();
}

function adminRenameUsername(oldUsername, newUsername){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  oldUsername = (oldUsername||"").trim();
  newUsername = (newUsername||"").trim();
  if(!oldUsername || !newUsername) return toast("Enter username.");
  if(oldUsername === ADMIN_USERNAME) return toast("Can't rename main admin.");
  if(newUsername.length < 3) return toast("New username too short.");

  const users = loadUsers();
  if(!users[oldUsername]) return toast("Old user not found.");
  if(users[newUsername]) return toast("New username already exists.");

  const u = users[oldUsername];
  delete users[oldUsername];

  u.username = newUsername;
  users[newUsername] = u;

  // If session was old user, move session
  const sess = loadSession();
  if(sess.username === oldUsername) saveSession({username:newUsername});

  saveUsers(users);
  toast("Username changed.");
  renderAll();
}

function renderAdminUsers(){
  const wrap = document.getElementById("adminUsers");
  if(!isAdmin()){
    wrap.innerHTML = `<p class="text-gray-400 italic">Admins only.</p>`;
    return;
  }

  const users = loadUsers();
  const list = Object.values(users).sort((a,b)=> (a.username||"").localeCompare(b.username||""));

  wrap.innerHTML = list.map(user=>{
    const isMain = user.username === ADMIN_USERNAME;
    const uname = escapeHTML(user.username);
    const oldU = user.username;

    return `
      <div class="border border-gray-100 rounded-3xl p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-extrabold text-gray-800">
              ${escapeHTML(user.displayName)}
              <span class="text-gray-400 font-bold">@${uname}</span>
              <span class="ml-2 text-xs font-extrabold px-2 py-1 rounded-full ${user.role==="Admin" ? "bg-red-50 text-red-700 border border-red-200" : "bg-gray-50 text-gray-700 border border-gray-200"}">
                ${user.role || "Member"}
              </span>
              ${user.hideFromLeaderboard ? `<span class="ml-2 text-xs font-extrabold px-2 py-1 rounded-full bg-gray-50 text-gray-600 border border-gray-200">Hidden</span>` : ``}
            </div>
            <div class="text-xs text-gray-500 mt-1">
              Total: <b class="text-green-700">${user.totalDays||0}</b>
              ‚Ä¢ Streak: <b class="text-green-700">${user.streak||0}</b>
              ‚Ä¢ Last: <b>${user.lastDone||"‚Äî"}</b>
            </div>
          </div>

          ${isMain ? `` : `
            <button onclick="adminDeleteUser('${escapeHTML(oldU)}')"
              class="shrink-0 text-sm font-extrabold px-3 py-2 rounded-2xl bg-red-50 text-red-700 border border-red-200 hover:bg-red-100">
              Delete
            </button>
          `}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">

          <div>
            <label class="block text-xs font-bold text-gray-500 mb-1">Role</label>
            <select id="role_${uname}" class="w-full border p-3 rounded-xl focus:outline-green-600" ${isMain ? "disabled" : ""}>
              <option value="Member" ${user.role!=="Admin" ? "selected" : ""}>Member</option>
              <option value="Admin" ${user.role==="Admin" ? "selected" : ""}>Admin</option>
            </select>
            <button ${isMain ? "disabled" : ""} onclick="adminSetRole('${escapeHTML(oldU)}', document.getElementById('role_${uname}').value)"
              class="mt-2 w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-2xl font-bold transition ${isMain ? "opacity-50 cursor-not-allowed" : ""}">
              Set Role
            </button>

            <label class="block text-xs font-bold text-gray-500 mt-4 mb-1">Show on leaderboard</label>
            <div class="flex items-center justify-between bg-gray-50 border border-gray-100 rounded-2xl p-3">
              <span class="text-sm font-semibold text-gray-700">Visible</span>
              <input type="checkbox"
                ${user.hideFromLeaderboard ? "" : "checked"}
                onchange="adminToggleHide('${escapeHTML(oldU)}', !this.checked)"
                class="w-5 h-5 accent-green-700" />
            </div>
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-500 mb-1">New password</label>
            <input id="pw_${uname}" class="w-full border p-3 rounded-xl focus:outline-green-600" type="password" placeholder="Enter new password">
            <button onclick="adminSetPassword('${escapeHTML(oldU)}', document.getElementById('pw_${uname}').value)"
              class="mt-2 w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-2xl font-bold transition">
              Change Password
            </button>

            <label class="block text-xs font-bold text-gray-500 mt-4 mb-1">Rename username</label>
            <input id="rename_${uname}" class="w-full border p-3 rounded-xl focus:outline-green-600" placeholder="New username">
            <button ${isMain ? "disabled" : ""} onclick="adminRenameUsername('${escapeHTML(oldU)}', document.getElementById('rename_${uname}').value)"
              class="mt-2 w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-2xl font-bold transition ${isMain ? "opacity-50 cursor-not-allowed" : ""}">
              Change Username
            </button>
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-500 mb-1">Set / Adjust Days</label>
            <input id="set_${uname}" class="w-full border p-3 rounded-xl focus:outline-green-600" inputmode="numeric" placeholder="e.g. 15">
            <div class="mt-2 grid grid-cols-5 gap-2">
              <button onclick="adminSetDays('${escapeHTML(oldU)}', document.getElementById('set_${uname}').value)"
                class="col-span-2 bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-2xl font-bold transition">Set</button>
              <button onclick="adminAdjustDays('${escapeHTML(oldU)}', 1)"
                class="bg-green-50 hover:bg-green-100 text-green-800 py-3 rounded-2xl font-bold border border-green-200">+1</button>
              <button onclick="adminAdjustDays('${escapeHTML(oldU)}', -1)"
                class="bg-red-50 hover:bg-red-100 text-red-700 py-3 rounded-2xl font-bold border border-red-200">-1</button>
              <button onclick="adminAdjustDays('${escapeHTML(oldU)}', 7)"
                class="bg-green-50 hover:bg-green-100 text-green-800 py-3 rounded-2xl font-bold border border-green-200">+7</button>
            </div>
          </div>

        </div>
      </div>
    `;
  }).join("");
}

async function exportData(){
  const data = { settings: loadSettings(), users: loadUsers() };
  const text = JSON.stringify(data, null, 2);
  try{
    await navigator.clipboard.writeText(text);
    toast("Copied JSON.");
  }catch{
    prompt("Copy JSON:", text);
  }
}

function wipeAll(){
  if(!isAdmin()) return toast("Admins only.");
  if(!confirm("Wipe ALL app data? This cannot be undone.")) return;
  localStorage.removeItem(KEY_USERS);
  localStorage.removeItem(KEY_SESSION);
  localStorage.removeItem(KEY_SETTINGS);
  location.reload();
}

/* ======================
   PDF / Print
====================== */
function buildPdfData(){
  const settings = loadSettings();
  const me = getCurrentUser();
  const name = me ? me.displayName : "Guest";
  const topN = Math.max(1, Number(settings.topN) || 10);

  const showForPdf = isAdmin() ? settings.showLeaderboard : settings.showLeaderboard;

  document.getElementById("pdfGreeting").textContent = `As-salaamu alaikum, ${name}`;
  document.getElementById("pdfEventLine").textContent = `Event: ${settings.eventName} ‚Ä¢ Target: ${settings.targetDateTime}`;

  document.getElementById("pdfLeaderboardBlock").classList.toggle("hidden", !showForPdf);

  const pdfList = document.getElementById("pdfLeaderboard");
  pdfList.innerHTML = "";

  if(showForPdf){
    const sorted = getSortedUsers();
    const top = sorted.slice(0, topN);

    pdfList.innerHTML = top.map((u,i)=>{
      const hasStreak = (u.streak||0) >= 2;
      const nameStyle = hasStreak ? "text-red-600 font-extrabold" : "text-gray-900 font-bold";
      const flame = hasStreak ? " üî•" : "";
      return `
        <div class="flex justify-between items-center p-3 rounded-xl border border-gray-100">
          <div>
            <span class="text-gray-500 font-bold">${i+1}.</span>
            <span class="${nameStyle} ml-2">${escapeHTML(u.displayName)}${flame}</span>
            <span class="text-xs text-gray-500 ml-2">@${escapeHTML(u.username)}</span>
          </div>
          <div class="font-extrabold text-green-800">${u.totalDays||0} Days</div>
        </div>
      `;
    }).join("");
  }

  const rankBlock = document.getElementById("pdfYourRankBlock");
  const rankText = document.getElementById("pdfYourRank");

  if(me && !me.hideFromLeaderboard){
    const rank = computeRank(me.username);
    if(rank !== null){
      const msg = (rank <= topN)
        ? `You are in the Top ${topN}: #${rank}`
        : `Your place is #${rank}`;
      rankText.textContent = msg;
      rankBlock.classList.remove("hidden");
    } else {
      rankBlock.classList.add("hidden");
    }
  } else {
    rankText.textContent = `Login to see your place`;
    rankBlock.classList.remove("hidden");
  }
}

function openPdfViewAndPrint(){
  buildPdfData();
  window.print();
}

/* ======================
   Render UI
====================== */
function getRecitationLabel(){
  const s = loadSettings();
  return (s.quranPreviewTitle || "Quran Pages").trim();
}

function renderAuthUI(){
  const settings = loadSettings();
  const me = getCurrentUser();
  const locked = isMemberLocked();

  document.title = settings.appName;
  document.getElementById("navTitle").textContent = settings.appName;

  // Lockdown banner shows when target passed
  const targetPassed = Date.now() >= parseTargetDateTime(settings.targetDateTime);
  document.getElementById("lockdownBanner").classList.toggle("hidden", !targetPassed);

  // Auth buttons: hide if logged in; if locked, only allow Admin login
  const isLoggedIn = !!me;
  document.getElementById("authBtnTop").classList.toggle("hidden", isLoggedIn);
  document.getElementById("authBtnMenu").classList.toggle("hidden", isLoggedIn);
  document.getElementById("logoutBtn").classList.toggle("hidden", !isLoggedIn);

  // Admin nav
  document.getElementById("adminNavBtn").classList.toggle("hidden", !(me && me.role === "Admin"));

  // Menu hint
  document.getElementById("menuHint").textContent = me ? `Logged in as ${me.displayName}` : (locked ? "Members read-only" : "Login to start");

  // Home blocks
  document.getElementById("guestPrompt").classList.toggle("hidden", !!me || locked);
  document.getElementById("userStats").classList.toggle("hidden", !me || locked);
  document.getElementById("lockedPromptHome").classList.toggle("hidden", !locked);

  // Counting page blocks
  document.getElementById("countingGuest").classList.toggle("hidden", !!me || locked);
  document.getElementById("countingUser").classList.toggle("hidden", !me || locked);
  document.getElementById("countingLocked").classList.toggle("hidden", !locked);

  // Button label
  const label = getRecitationLabel();
  document.getElementById("quranTitle").textContent = label;

  if(!me || locked) return;

  document.getElementById("displayName").textContent = me.displayName;
  document.getElementById("streakCount").textContent = me.streak || 0;

  const done = alreadyDoneToday(me);
  const btns = [document.getElementById("markDoneBtn"), document.getElementById("countBtn")];

  btns.forEach(b=>{
    if(done){
      b.innerText = "Already Completed Today! ‚ú®";
      b.disabled = true;
      b.className = "w-full bg-gray-300 text-gray-600 py-4 rounded-2xl font-bold cursor-not-allowed";
    } else {
      b.innerText = `I Recited ${label} Today`;
      b.disabled = false;
      b.className = "w-full bg-green-600 text-white py-4 rounded-2xl font-bold hover:bg-green-700 transition";
    }
  });

  const total = me.totalDays || 0;
  document.getElementById("ordinalLine").textContent =
    total > 0 ? `This is your ${ordinal(total)} day.` : `This is your 0th day (press the button to start).`;

  document.getElementById("countStatus").textContent = done ? "Completed today ‚úÖ" : "Not completed yet";
  document.getElementById("countOrdinal").textContent = total > 0 ? `Your ${ordinal(total)} day` : `Your 0th day`;
}

function renderAll(){
  renderAuthUI();
  updateCountdown();
  renderLeaderboard();

  const s = loadSettings();
  if(currentPage === null) currentPage = s.startPage;
  renderQuran(false);

  renderAdminUsers();
}

/* ======================
   Wiring
====================== */
document.getElementById("searchBox").addEventListener("input", renderLeaderboard);
window.addEventListener("resize", ()=> renderQuran(false));
wireSwipe();

/* ======================
   Boot
====================== */
(async function boot(){
  const s = loadSettings();
  saveSettings(s);
  await ensureAdmin();

  updateCountdown();
  setInterval(updateCountdown, 1000);

  currentPage = loadSettings().startPage;
  renderAll();
})();

</script>
</body>
</html>
