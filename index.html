<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Streak App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#f4f7f4}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:20px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
    .btn{border-radius:14px;padding:.75rem 1rem;font-weight:800}
    .input{border:1px solid #e5e7eb;border-radius:14px;padding:.75rem 1rem;width:100%}
    .small{font-size:.85rem}
    .badge{border-radius:999px;padding:.25rem .6rem;font-weight:800;font-size:.75rem}
  </style>
</head>

<body class="pb-14">
  <!-- Top Bar -->
  <div class="sticky top-0 z-20 bg-green-900 text-white">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="font-extrabold text-lg" id="appTitle">BaqarahStreak üåô</div>

      <div class="flex items-center gap-2">
        <div id="whoBox" class="hidden small text-white/90"></div>

        <button id="loginBtnTop" class="btn bg-white text-green-900" onclick="openAuth()">Login / Sign Up</button>
        <button id="logoutBtnTop" class="btn bg-white/10 text-white hidden" onclick="logout()">Logout</button>

        <button class="btn bg-white/10 text-white" onclick="toggleMenu()" aria-label="Menu">‚ò∞</button>
      </div>
    </div>
  </div>

  <!-- Menu -->
  <div id="menu" class="hidden fixed right-4 top-[76px] w-[250px] card overflow-hidden z-30">
    <div class="px-4 py-3 border-b border-gray-100">
      <div class="text-xs text-gray-500">Navigation</div>
      <div id="menuHint" class="font-extrabold">‚Äî</div>
    </div>

    <button class="w-full text-left px-4 py-3 hover:bg-gray-50 font-bold" onclick="showView('home')">üè† Home</button>
    <button class="w-full text-left px-4 py-3 hover:bg-gray-50 font-bold" onclick="showView('leaderboard')">üèÜ Leaderboard</button>
    <button class="w-full text-left px-4 py-3 hover:bg-gray-50 font-bold" onclick="showView('counting')">‚úÖ Counting</button>
    <button id="adminMenuBtn" class="hidden w-full text-left px-4 py-3 hover:bg-gray-50 font-bold" onclick="showView('admin')">üîí Admin</button>

    <div class="border-t border-gray-100"></div>
    <button id="loginBtnMenu" class="w-full text-left px-4 py-3 hover:bg-gray-50 font-bold text-green-800" onclick="openAuth()">Login / Sign Up</button>
    <button id="logoutBtnMenu" class="hidden w-full text-left px-4 py-3 hover:bg-gray-50 font-bold text-red-600" onclick="logout()">Logout</button>
  </div>

  <!-- Main -->
  <div class="max-w-5xl mx-auto px-4 mt-6 space-y-6">

    <!-- Countdown -->
    <div class="card p-6">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
        <div>
          <div class="text-2xl font-black text-gray-900" id="countTitle">Days till: Ramadan 2026</div>
          <div class="text-gray-500 small" id="countTarget">Target: 2026-02-18 00:00:00</div>
        </div>
        <div class="grid grid-cols-4 gap-3 w-full md:w-auto">
          <div class="bg-green-50 rounded-xl p-3 text-center">
            <div class="text-2xl font-black text-green-900" id="d">00</div><div class="text-xs uppercase text-green-700">Days</div>
          </div>
          <div class="bg-green-50 rounded-xl p-3 text-center">
            <div class="text-2xl font-black text-green-900" id="h">00</div><div class="text-xs uppercase text-green-700">Hours</div>
          </div>
          <div class="bg-green-50 rounded-xl p-3 text-center">
            <div class="text-2xl font-black text-green-900" id="m">00</div><div class="text-xs uppercase text-green-700">Mins</div>
          </div>
          <div class="bg-green-50 rounded-xl p-3 text-center">
            <div class="text-2xl font-black text-green-900" id="s">00</div><div class="text-xs uppercase text-green-700">Secs</div>
          </div>
        </div>
      </div>
      <div id="lockedBanner" class="hidden mt-4 bg-red-50 border border-red-200 text-red-800 rounded-2xl p-4 font-bold">
        Read-only mode is active (event started). Login/signup/counting/admin are disabled.
      </div>
    </div>

    <!-- HOME -->
    <div id="viewHome" class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="card p-6">
        <div class="text-xl font-black text-gray-900 mb-3">Today's Progress</div>

        <div id="homeGuest" class="text-center py-10">
          <div class="text-gray-500 mb-3">Login to track your streak.</div>
          <button class="btn bg-green-700 text-white w-full" onclick="openAuth()">Login / Sign Up</button>
        </div>

        <div id="homeUser" class="hidden">
          <div class="text-gray-600 mb-3">As-salaamu alaikum, <span class="font-black text-green-800" id="homeName">‚Äî</span></div>
          <div class="bg-green-50 rounded-2xl p-5 text-center border border-green-100">
            <div class="text-sm text-green-800 font-bold">Current Streak</div>
            <div class="text-5xl font-black text-green-900" id="homeStreak">0</div>
            <div class="text-sm text-gray-500 mt-1">Total days: <b id="homeTotal">0</b></div>
          </div>

          <button id="doneBtn" class="btn bg-green-700 text-white w-full mt-4" onclick="markDone()">
            I Completed Today
          </button>

          <div class="text-center font-black text-green-800 mt-3" id="homeOrdinal">‚Äî</div>
        </div>
      </div>

      <div class="card p-6">
        <div class="flex items-center justify-between gap-2 mb-3">
          <div class="text-xl font-black text-gray-900" id="lbTitle">Leaderboard</div>
          <div class="text-xs text-gray-500 font-bold" id="lbTopNote">Top 10</div>
        </div>

        <input id="lbSearch" class="input mb-4" placeholder="Search..." />
        <div id="lbHidden" class="hidden text-gray-500 text-center py-8">Leaderboard hidden by admin.</div>
        <div id="lbList" class="space-y-2"></div>

        <div id="yourPlaceBox" class="hidden mt-4 bg-green-50 border border-green-100 rounded-2xl p-4 text-center">
          <div class="font-black text-green-900" id="yourPlaceText">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- COUNTING -->
    <div id="viewCounting" class="hidden card p-6">
      <div class="text-xl font-black text-gray-900 mb-2">Counting</div>

      <div id="countGuest" class="text-center py-10">
        <div class="text-gray-500 mb-3">Login to use counting.</div>
        <button class="btn bg-green-700 text-white w-full" onclick="openAuth()">Login / Sign Up</button>
      </div>

      <div id="countUser" class="hidden">
        <button class="btn bg-green-700 text-white w-full" onclick="markDone()">I Completed Today</button>
        <div class="mt-4 bg-green-50 border border-green-100 rounded-2xl p-4 text-center">
          <div class="text-sm text-green-800 font-bold" id="countStatus">‚Äî</div>
          <div class="text-lg font-black text-green-900" id="countOrdinal">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="viewAdmin" class="hidden card p-6">
      <div class="text-xl font-black text-gray-900 mb-1">Admin Panel</div>
      <div class="text-gray-500 small mb-5">
        Admin can create accounts, rename usernames, toggle leaderboard visibility per user, change role, reset password, and change days.
      </div>

      <!-- Settings -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
        <div class="border border-gray-100 rounded-2xl p-4">
          <div class="font-black text-gray-900 mb-3">App / Countdown</div>
          <label class="text-xs font-black text-gray-500">App name</label>
          <input id="setAppName" class="input mb-3" placeholder="BaqarahStreak üåô" />
          <label class="text-xs font-black text-gray-500">Event title</label>
          <input id="setEventName" class="input mb-3" placeholder="Ramadan 2026" />
          <label class="text-xs font-black text-gray-500">Target datetime (YYYY-MM-DD HH:MM:SS)</label>
          <input id="setTarget" class="input mb-3" placeholder="2026-02-18 00:00:00" />
          <div class="flex items-center justify-between bg-gray-50 border border-gray-100 rounded-2xl p-4 mb-3">
            <div class="font-black text-gray-700">Leaderboard visible</div>
            <input id="setShowLB" type="checkbox" class="scale-125" />
          </div>
          <label class="text-xs font-black text-gray-500">Top N</label>
          <input id="setTopN" class="input mb-3" inputmode="numeric" placeholder="10" />

          <button class="btn bg-green-800 text-white w-full" onclick="adminSaveSettings()">Save Settings</button>
        </div>

        <!-- Create user -->
        <div class="border border-gray-100 rounded-2xl p-4">
          <div class="font-black text-gray-900 mb-3">Create New Account</div>

          <input id="newUser" class="input mb-3" placeholder="Username" />
          <input id="newName" class="input mb-3" placeholder="Display Name" />
          <input id="newPass" class="input mb-3" placeholder="Password" type="password" />

          <div class="flex items-center justify-between bg-gray-50 border border-gray-100 rounded-2xl p-4 mb-3">
            <div class="font-black text-gray-700">Role</div>
            <select id="newRole" class="input" style="padding:.55rem 1rem;width:auto">
              <option value="Member" selected>Member</option>
              <option value="Admin">Admin</option>
            </select>
          </div>

          <div class="flex items-center justify-between bg-gray-50 border border-gray-100 rounded-2xl p-4 mb-3">
            <div class="font-black text-gray-700">Show on leaderboard</div>
            <input id="newShowLB" type="checkbox" class="scale-125" checked />
          </div>

          <button class="btn bg-green-800 text-white w-full" onclick="adminCreateUser()">Create Account</button>
          <div class="text-xs text-gray-400 mt-3">
            Note: this app stores data in each device browser (localStorage). GitHub Pages has no shared database.
          </div>
        </div>
      </div>

      <!-- User management -->
      <div class="mt-8">
        <div class="font-black text-gray-900 mb-3">Manage Users</div>
        <div id="adminUsers" class="space-y-3"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-6">
          <button class="btn bg-gray-100 text-gray-800 w-full" onclick="exportJSON()">Export JSON (Copy)</button>
          <button class="btn bg-red-50 text-red-700 border border-red-200 w-full" onclick="wipeAll()">Wipe ALL Data</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="hidden fixed inset-0 bg-black/50 z-40 flex items-center justify-center p-4">
    <div class="card w-full max-w-xl p-6">
      <div class="flex items-center justify-between mb-3">
        <div class="text-xl font-black">Login / Sign Up</div>
        <button class="btn bg-gray-100 text-gray-800" onclick="closeAuth()">‚úï</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="border border-gray-100 rounded-2xl p-4">
          <div class="font-black text-gray-900 mb-2">Login</div>
          <input id="liUser" class="input mb-3" placeholder="Username" />
          <input id="liPass" class="input mb-3" placeholder="Password" type="password" />
          <button class="btn bg-green-800 text-white w-full" onclick="login()">Login</button>
        </div>

        <div class="border border-gray-100 rounded-2xl p-4">
          <div class="font-black text-gray-900 mb-2">Sign Up</div>
          <input id="suUser" class="input mb-3" placeholder="Username" />
          <input id="suName" class="input mb-3" placeholder="Display Name" />
          <input id="suPass" class="input mb-3" placeholder="Password" type="password" />
          <button class="btn bg-gray-100 text-gray-800 w-full" onclick="signup()">Create account</button>
        </div>
      </div>

      <div class="text-center text-gray-400 small mt-3">Tip: username has no spaces.</div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 card px-4 py-3 z-50">
    <div class="font-black text-gray-900" id="toastMsg">‚Äî</div>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const ADMIN_USERNAME = "Admin00";
const ADMIN_PASSWORD = "Admin0000";

const KEY_USERS    = "streak_users_v1";
const KEY_SESSION  = "streak_session_v1";
const KEY_SETTINGS = "streak_settings_v1";

const DEFAULT_SETTINGS = {
  appName: "BaqarahStreak üåô",
  eventName: "Ramadan 2026",
  targetDateTime: "2026-02-18 00:00:00",
  showLeaderboard: true,
  topN: 10
};

/* =========================
   UTIL
========================= */
const $ = (id)=>document.getElementById(id);

function toast(msg){
  $("toastMsg").textContent = msg;
  $("toast").classList.remove("hidden");
  setTimeout(()=> $("toast").classList.add("hidden"), 2200);
}

function loadJSON(key, fallback){
  try{
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : fallback;
  }catch{
    return fallback;
  }
}
function saveJSON(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

function loadUsers(){ return loadJSON(KEY_USERS, {}); }
function saveUsers(u){ saveJSON(KEY_USERS, u); }

function loadSession(){ return loadJSON(KEY_SESSION, { username:null }); }
function saveSession(s){ saveJSON(KEY_SESSION, s); }

function loadSettings(){
  const s = loadJSON(KEY_SETTINGS, null);
  return s ? ({...DEFAULT_SETTINGS, ...s}) : ({...DEFAULT_SETTINGS});
}
function saveSettings(s){ saveJSON(KEY_SETTINGS, s); }

function normalizeUsername(u){
  return (u||"").trim().replace(/\s+/g,"");
}

function todayISO(){
  return new Date().toISOString().slice(0,10);
}
function yesterdayISO(){
  const d = new Date(); d.setDate(d.getDate()-1);
  return d.toISOString().slice(0,10);
}
function ordinal(n){
  const s=["th","st","nd","rd"], v=n%100;
  return n + (s[(v-20)%10] || s[v] || s[0]);
}

async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

function parseTargetDateTime(str){
  const s = (str||"").trim();
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})(?::(\d{2}))?$/);
  if(m){
    const [_,Y,Mo,D,H,Mi,S] = m;
    return new Date(+Y, +Mo-1, +D, +H, +Mi, +(S||"0")).getTime();
  }
  const d = new Date(s);
  if(!isNaN(d.getTime())) return d.getTime();
  return new Date(2026,1,18,0,0,0).getTime();
}

function isLocked(){
  const settings = loadSettings();
  return Date.now() >= parseTargetDateTime(settings.targetDateTime);
}

function currentUser(){
  const sess = loadSession();
  if(!sess.username) return null;
  return loadUsers()[sess.username] || null;
}

/* =========================
   MENU + VIEWS
========================= */
function toggleMenu(){ $("menu").classList.toggle("hidden"); }
document.addEventListener("click",(e)=>{
  const menu = $("menu");
  const isBtn = e.target.closest("button") && e.target.closest("button").getAttribute("aria-label")==="Menu";
  if(!menu.classList.contains("hidden")){
    if(!menu.contains(e.target) && !isBtn) menu.classList.add("hidden");
  }
});

function showView(name){
  $("menu").classList.add("hidden");
  $("viewHome").classList.toggle("hidden", name!=="home");
  $("viewCounting").classList.toggle("hidden", name!=="counting");
  $("viewAdmin").classList.toggle("hidden", name!=="admin");
  if(name==="admin") renderAdmin();
  if(name==="leaderboard"){
    window.scrollTo({top: $("lbTitle").offsetTop - 80, behavior:"smooth"});
  } else {
    window.scrollTo({top: 0, behavior:"smooth"});
  }
}

/* =========================
   AUTH MODAL
========================= */
function openAuth(){
  if(isLocked()) return toast("Read-only mode.");
  $("authModal").classList.remove("hidden");
}
function closeAuth(){ $("authModal").classList.add("hidden"); }
window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeAuth(); });

async function ensureAdmin(){
  const users = loadUsers();
  if(!users[ADMIN_USERNAME]){
    users[ADMIN_USERNAME] = {
      username: ADMIN_USERNAME,
      displayName: "Admin",
      passHash: await sha256(ADMIN_PASSWORD),
      role: "Admin",
      showOnLeaderboard: true,
      totalDays: 0,
      streak: 0,
      lastDone: null,
      createdAt: Date.now()
    };
    saveUsers(users);
  } else {
    users[ADMIN_USERNAME].role = "Admin";
    if(users[ADMIN_USERNAME].showOnLeaderboard === undefined) users[ADMIN_USERNAME].showOnLeaderboard = true;
    saveUsers(users);
  }
}

async function signup(){
  if(isLocked()) return toast("Read-only mode.");
  const username = normalizeUsername($("suUser").value);
  const displayName = ($("suName").value||"").trim();
  const password = ($("suPass").value||"").trim();

  if(!username || !displayName || !password) return toast("Fill all fields.");
  if(username.length < 3) return toast("Username too short.");

  const users = loadUsers();
  if(users[username]) return toast("Username already exists.");

  users[username] = {
    username, displayName,
    passHash: await sha256(password),
    role: "Member",
    showOnLeaderboard: true,
    totalDays: 0,
    streak: 0,
    lastDone: null,
    createdAt: Date.now()
  };
  saveUsers(users);
  toast("Account created!");
  $("suUser").value=""; $("suName").value=""; $("suPass").value="";
  renderAll();
}

async function login(){
  if(isLocked()) return toast("Read-only mode.");
  const username = normalizeUsername($("liUser").value);
  const password = ($("liPass").value||"").trim();
  if(!username || !password) return toast("Enter username + password.");

  const users = loadUsers();
  const u = users[username];
  if(!u) return toast("User not found.");

  const h = await sha256(password);
  if(h !== u.passHash) return toast("Wrong password.");

  saveSession({username});
  closeAuth();
  toast("Logged in.");
  renderAll();
}

function logout(){
  saveSession({username:null});
  toast("Logged out.");
  renderAll();
}

/* =========================
   COUNTING
========================= */
function alreadyDoneToday(u){ return u.lastDone === todayISO(); }

function markDone(){
  if(isLocked()) return toast("Read-only mode.");
  const u = currentUser();
  if(!u) return toast("Login first.");

  if(alreadyDoneToday(u)) return toast("Already done today.");

  const users = loadUsers();
  const me = users[u.username];

  // streak logic
  if(me.lastDone === yesterdayISO()) me.streak = (me.streak||0) + 1;
  else me.streak = 1;

  me.totalDays = (me.totalDays||0) + 1;
  me.lastDone = todayISO();

  users[me.username] = me;
  saveUsers(users);

  toast("Saved ‚úÖ");
  renderAll();
}

/* =========================
   LEADERBOARD
   - filters: showOnLeaderboard !== false
========================= */
function getSortedLeaderboardUsers(){
  const all = Object.values(loadUsers()).filter(x=>x && x.username);
  const visible = all.filter(x => x.showOnLeaderboard !== false);

  visible.sort((a,b)=>
    (b.totalDays||0) - (a.totalDays||0) ||
    (b.streak||0) - (a.streak||0) ||
    (a.username||"").localeCompare(b.username||"")
  );
  return visible;
}

function computeRank(username){
  const list = getSortedLeaderboardUsers();
  const idx = list.findIndex(x=>x.username===username);
  return idx === -1 ? null : (idx+1);
}

function renderLeaderboard(){
  const settings = loadSettings();
  const topN = Math.max(1, Number(settings.topN)||10);
  $("lbTopNote").textContent = `Top ${topN}`;
  $("lbTitle").textContent = `Leaderboard`;

  const show = !!settings.showLeaderboard;
  $("lbHidden").classList.toggle("hidden", show);
  $("lbSearch").classList.toggle("hidden", !show);
  $("lbList").innerHTML = "";

  if(!show){
    $("yourPlaceBox").classList.add("hidden");
    return;
  }

  const q = ($("lbSearch").value||"").trim().toLowerCase();
  let list = getSortedLeaderboardUsers().slice(0, topN);

  if(q){
    list = list.filter(u =>
      (u.username||"").toLowerCase().includes(q) ||
      (u.displayName||"").toLowerCase().includes(q)
    );
  }

  if(list.length === 0){
    $("lbList").innerHTML = `<div class="text-center text-gray-400 italic py-6">No results.</div>`;
  } else {
    $("lbList").innerHTML = list.map((u,i)=>{
      const flame = (u.streak||0) >= 2 ? " üî•" : "";
      const nameClass = (u.streak||0) >= 2 ? "text-red-600 font-black" : "text-gray-900 font-extrabold";
      return `
        <div class="flex items-center justify-between bg-gray-50 border border-gray-100 rounded-2xl p-3">
          <div class="flex items-center gap-3">
            <div class="font-black text-gray-500 w-8">${i+1}.</div>
            <div>
              <div class="${nameClass}">${escapeHtml(u.displayName)}${flame}</div>
              <div class="text-xs text-gray-500">@${escapeHtml(u.username)}</div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-black text-green-800">${u.totalDays||0} Days</div>
            <div class="text-xs text-gray-500">Streak ${u.streak||0}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  const me = currentUser();
  if(!me){
    $("yourPlaceBox").classList.add("hidden");
    return;
  }

  const r = computeRank(me.username);
  $("yourPlaceBox").classList.remove("hidden");
  if(r === null){
    $("yourPlaceText").textContent = "You are hidden from leaderboard (admin setting).";
  } else if(r <= topN){
    $("yourPlaceBox").classList.add("hidden");
  } else {
    $("yourPlaceText").textContent = `Your place: #${r}`;
  }
}

function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   ADMIN
========================= */
function adminGuard(){
  if(isLocked()) return {ok:false, msg:"Read-only mode."};
  const me = currentUser();
  if(!me || me.role !== "Admin") return {ok:false, msg:"Admins only."};
  return {ok:true, msg:"ok"};
}

function fillAdminSettings(){
  const s = loadSettings();
  $("setAppName").value = s.appName;
  $("setEventName").value = s.eventName;
  $("setTarget").value = s.targetDateTime;
  $("setShowLB").checked = !!s.showLeaderboard;
  $("setTopN").value = s.topN;
}

function adminSaveSettings(){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  const s = loadSettings();
  s.appName = ($("setAppName").value||"").trim() || DEFAULT_SETTINGS.appName;
  s.eventName = ($("setEventName").value||"").trim() || DEFAULT_SETTINGS.eventName;
  s.targetDateTime = ($("setTarget").value||"").trim() || DEFAULT_SETTINGS.targetDateTime;
  s.showLeaderboard = !!$("setShowLB").checked;

  const n = Number($("setTopN").value);
  s.topN = (Number.isFinite(n) && n>=1 && n<=200) ? Math.floor(n) : 10;

  saveSettings(s);
  toast("Settings saved.");
  renderAll();
}

async function adminCreateUser(){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  const username = normalizeUsername($("newUser").value);
  const displayName = ($("newName").value||"").trim();
  const password = ($("newPass").value||"").trim();
  const role = ($("newRole").value === "Admin") ? "Admin" : "Member";
  const showOnLeaderboard = !!$("newShowLB").checked;

  if(!username || !displayName || !password) return toast("Fill all fields.");
  if(username.length < 3) return toast("Username too short.");
  if(password.length < 4) return toast("Password too short.");

  const users = loadUsers();
  if(users[username]) return toast("Username already exists.");

  users[username] = {
    username, displayName,
    passHash: await sha256(password),
    role,
    showOnLeaderboard,
    totalDays: 0,
    streak: 0,
    lastDone: null,
    createdAt: Date.now()
  };
  saveUsers(users);

  $("newUser").value=""; $("newName").value=""; $("newPass").value="";
  $("newRole").value="Member"; $("newShowLB").checked=true;

  toast("User created.");
  renderAll();
}

async function adminResetPassword(username, newPass){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  newPass = (newPass||"").trim();
  if(newPass.length < 4) return toast("Password too short.");

  const users = loadUsers();
  if(!users[username]) return toast("User not found.");
  users[username].passHash = await sha256(newPass);
  saveUsers(users);
  toast("Password updated.");
  renderAll();
}

function adminSetRole(username, role){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);
  if(username === ADMIN_USERNAME) return toast("Main admin role locked.");

  const users = loadUsers();
  if(!users[username]) return toast("User not found.");
  users[username].role = (role==="Admin") ? "Admin" : "Member";
  saveUsers(users);
  toast("Role updated.");
  renderAll();
}

function adminSetShowLB(username, show){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  const users = loadUsers();
  if(!users[username]) return toast("User not found.");
  users[username].showOnLeaderboard = !!show;
  saveUsers(users);
  toast("Saved.");
  renderAll();
}

function adminSetDays(username, days){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  const n = Number(days);
  if(!Number.isFinite(n) || n < 0) return toast("Enter valid days.");

  const users = loadUsers();
  if(!users[username]) return toast("User not found.");
  users[username].totalDays = Math.floor(n);
  saveUsers(users);
  toast("Days set.");
  renderAll();
}

function adminAdjustDays(username, delta){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  const users = loadUsers();
  if(!users[username]) return toast("User not found.");
  users[username].totalDays = Math.max(0, (users[username].totalDays||0) + delta);
  saveUsers(users);
  toast("Days updated.");
  renderAll();
}

function adminRenameUser(oldU, newU){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);

  if(oldU === ADMIN_USERNAME) return toast("Can't rename main admin.");
  newU = normalizeUsername(newU);
  if(!newU || newU.length < 3) return toast("New username too short.");

  const users = loadUsers();
  if(!users[oldU]) return toast("User not found.");
  if(users[newU]) return toast("New username exists.");

  const obj = users[oldU];
  delete users[oldU];
  obj.username = newU;
  users[newU] = obj;
  saveUsers(users);

  const sess = loadSession();
  if(sess.username === oldU) saveSession({username:newU});

  toast("Username renamed.");
  renderAll();
}

function adminDeleteUser(username){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);
  if(username === ADMIN_USERNAME) return toast("Can't delete main admin.");

  if(!confirm(`Delete @${username}?`)) return;

  const users = loadUsers();
  delete users[username];
  saveUsers(users);

  const sess = loadSession();
  if(sess.username === username) saveSession({username:null});

  toast("User deleted.");
  renderAll();
}

function renderAdminUsers(){
  const users = loadUsers();
  const list = Object.values(users).sort((a,b)=>(a.username||"").localeCompare(b.username||""));

  $("adminUsers").innerHTML = list.map(u=>{
    const isMain = u.username === ADMIN_USERNAME;
    const showLB = u.showOnLeaderboard !== false;

    return `
      <div class="border border-gray-100 rounded-2xl p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-black text-gray-900">
              ${escapeHtml(u.displayName)}
              <span class="text-gray-400 font-extrabold">@${escapeHtml(u.username)}</span>
              <span class="badge ${u.role==="Admin"?"bg-red-50 text-red-700 border border-red-200":"bg-gray-50 text-gray-700 border border-gray-200"}">
                ${escapeHtml(u.role||"Member")}
              </span>
              <span class="badge ${showLB?"bg-green-50 text-green-800 border border-green-200":"bg-gray-50 text-gray-700 border border-gray-200"}">
                LB ${showLB?"ON":"OFF"}
              </span>
            </div>
            <div class="text-xs text-gray-500 mt-1">
              Total <b class="text-green-800">${u.totalDays||0}</b> ‚Ä¢ Streak <b class="text-green-800">${u.streak||0}</b> ‚Ä¢ Last <b>${escapeHtml(u.lastDone||"‚Äî")}</b>
            </div>
          </div>

          ${isMain ? "" : `
            <button class="btn bg-red-50 text-red-700 border border-red-200" onclick="adminDeleteUser('${escapeHtml(u.username)}')">
              Delete
            </button>
          `}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mt-4">

          <div>
            <div class="text-xs font-black text-gray-500 mb-1">Role</div>
            <select id="role_${u.username}" class="input" ${isMain?"disabled":""}>
              <option value="Member" ${u.role!=="Admin"?"selected":""}>Member</option>
              <option value="Admin" ${u.role==="Admin"?"selected":""}>Admin</option>
            </select>
            <button class="btn bg-gray-100 text-gray-800 w-full mt-2 ${isMain?"opacity-50 cursor-not-allowed":""}"
              ${isMain?"disabled":""}
              onclick="adminSetRole('${escapeHtml(u.username)}', document.getElementById('role_${u.username}').value)">
              Set
            </button>
          </div>

          <div>
            <div class="text-xs font-black text-gray-500 mb-1">Show on leaderboard</div>
            <div class="bg-gray-50 border border-gray-100 rounded-2xl p-4 flex items-center justify-between">
              <div class="font-black text-gray-700">${showLB?"Visible":"Hidden"}</div>
              <input id="lb_${u.username}" type="checkbox" class="scale-125" ${showLB?"checked":""}>
            </div>
            <button class="btn bg-gray-100 text-gray-800 w-full mt-2"
              onclick="adminSetShowLB('${escapeHtml(u.username)}', document.getElementById('lb_${u.username}').checked)">
              Save
            </button>
          </div>

          <div>
            <div class="text-xs font-black text-gray-500 mb-1">Reset password</div>
            <input id="pw_${u.username}" class="input" placeholder="New password" type="password">
            <button class="btn bg-gray-100 text-gray-800 w-full mt-2"
              onclick="adminResetPassword('${escapeHtml(u.username)}', document.getElementById('pw_${u.username}').value)">
              Update
            </button>
          </div>

          <div>
            <div class="text-xs font-black text-gray-500 mb-1">Set total days</div>
            <input id="days_${u.username}" class="input" placeholder="e.g. 12" inputmode="numeric">
            <div class="grid grid-cols-3 gap-2 mt-2">
              <button class="btn bg-gray-100 text-gray-800" onclick="adminSetDays('${escapeHtml(u.username)}', document.getElementById('days_${u.username}').value)">Set</button>
              <button class="btn bg-green-50 text-green-800 border border-green-200" onclick="adminAdjustDays('${escapeHtml(u.username)}', 1)">+1</button>
              <button class="btn bg-red-50 text-red-700 border border-red-200" onclick="adminAdjustDays('${escapeHtml(u.username)}', -1)">-1</button>
            </div>
          </div>

          <div>
            <div class="text-xs font-black text-gray-500 mb-1">Rename username</div>
            <input id="ren_${u.username}" class="input" placeholder="New username" ${isMain?"disabled":""}>
            <button class="btn bg-gray-100 text-gray-800 w-full mt-2 ${isMain?"opacity-50 cursor-not-allowed":""}"
              ${isMain?"disabled":""}
              onclick="adminRenameUser('${escapeHtml(u.username)}', document.getElementById('ren_${u.username}').value)">
              Rename
            </button>
          </div>

        </div>
      </div>
    `;
  }).join("");
}

function renderAdmin(){
  const g = adminGuard();
  if(!g.ok){
    toast(g.msg);
    showView("home");
    return;
  }
  fillAdminSettings();
  renderAdminUsers();
}

/* =========================
   EXPORT / WIPE
========================= */
async function exportJSON(){
  const data = { settings: loadSettings(), users: loadUsers() };
  const text = JSON.stringify(data, null, 2);
  try{
    await navigator.clipboard.writeText(text);
    toast("Copied JSON.");
  }catch{
    prompt("Copy JSON:", text);
  }
}

function wipeAll(){
  const g = adminGuard();
  if(!g.ok) return toast(g.msg);
  if(!confirm("Wipe ALL app data?")) return;

  localStorage.removeItem(KEY_USERS);
  localStorage.removeItem(KEY_SESSION);
  localStorage.removeItem(KEY_SETTINGS);
  location.reload();
}

/* =========================
   RENDER UI
========================= */
function renderTopUI(){
  const s = loadSettings();
  $("appTitle").textContent = s.appName;
  document.title = s.appName;

  const me = currentUser();
  const locked = isLocked();

  $("lockedBanner").classList.toggle("hidden", !locked);

  // buttons
  $("loginBtnTop").classList.toggle("hidden", !!me || locked);
  $("logoutBtnTop").classList.toggle("hidden", !me || locked);

  $("loginBtnMenu").classList.toggle("hidden", !!me || locked);
  $("logoutBtnMenu").classList.toggle("hidden", !me || locked);

  $("adminMenuBtn").classList.toggle("hidden", !(me && me.role==="Admin") || locked);

  $("menuHint").textContent = me ? `Logged in as ${me.displayName}` : (locked ? "Read-only mode" : "Login to start");

  $("whoBox").classList.toggle("hidden", !me);
  if(me) $("whoBox").textContent = `${me.displayName} (${me.role})`;

  // home/count visibility
  $("homeGuest").classList.toggle("hidden", !!me || locked);
  $("homeUser").classList.toggle("hidden", !me || locked);

  $("countGuest").classList.toggle("hidden", !!me || locked);
  $("countUser").classList.toggle("hidden", !me || locked);

  // disable done button when locked
  $("doneBtn").disabled = locked;
  $("doneBtn").classList.toggle("opacity-50", locked);
  $("doneBtn").classList.toggle("cursor-not-allowed", locked);

  // fill user stats
  if(me && !locked){
    $("homeName").textContent = me.displayName;
    $("homeStreak").textContent = me.streak || 0;
    $("homeTotal").textContent = me.totalDays || 0;

    $("homeOrdinal").textContent = `This is your ${ordinal((me.totalDays||0))} day.`;
    $("countStatus").textContent = alreadyDoneToday(me) ? "Already completed today ‚úÖ" : "Not completed today";
    $("countOrdinal").textContent = `Total completed days: ${me.totalDays||0}`;
  }
}

function updateCountdown(){
  const s = loadSettings();
  $("countTitle").textContent = `Days till: ${s.eventName}`;
  $("countTarget").textContent = `Target: ${s.targetDateTime}`;

  const target = parseTargetDateTime(s.targetDateTime);
  const dist = target - Date.now();

  if(dist <= 0){
    $("d").textContent="00"; $("h").textContent="00"; $("m").textContent="00"; $("s").textContent="00";
    return;
  }

  const dd = Math.floor(dist/(1000*60*60*24));
  const hh = Math.floor((dist%(1000*60*60*24))/(1000*60*60));
  const mm = Math.floor((dist%(1000*60*60))/(1000*60));
  const ss = Math.floor((dist%(1000*60))/1000);

  $("d").textContent = String(dd).padStart(2,"0");
  $("h").textContent = String(hh).padStart(2,"0");
  $("m").textContent = String(mm).padStart(2,"0");
  $("s").textContent = String(ss).padStart(2,"0");
}

function renderAll(){
  renderTopUI();
  renderLeaderboard();
  updateCountdown();
}

$("lbSearch").addEventListener("input", renderLeaderboard);

/* =========================
   BOOT
========================= */
(async function boot(){
  await ensureAdmin();
  renderAll();
  setInterval(updateCountdown, 1000);
})();
</script>
</body>
</html>
